name: Install OpenSearch

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment Name"
        required: false
        default: "dev"

jobs:
  Install-OpenSearch:
    environment: "${{github.event.inputs.environment}}"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Listing downloaded files
        run: |
          pwd
          ls -R ./

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.32.0'

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Verify tools
        run: |
          kubectl version --client
          helm version
          aws --version

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Configure kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --region ${{ vars.AWS_REGION || 'us-east-1' }} --name ${{ vars.AWS_CLUSTERNAME }}

      - name: Verify cluster access
        run: kubectl get nodes

      - name: Install OpenSearch
        run: |
          echo "Clean previously installed OpenSearch"
          kubectl delete ns ${{ vars.OPENSEARCH_INSTALL_NAMESPACE }} || true
          echo "Namespace to install: ${{ vars.OPENSEARCH_INSTALL_NAMESPACE }}"
          
          # Build helm arguments dynamically (only add non-empty values)
          HELM_ARGS=""
          
          # Enable integration tests
          HELM_ARGS="$HELM_ARGS --set integrationTests.enabled=true"
          
          # Secrets - S3 credentials for test results upload
          [ -n "${{ secrets.S3_AWS_ACCESS_KEY_ID }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.username=${{ secrets.S3_AWS_ACCESS_KEY_ID }}"
          [ -n "${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.password=${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}"
          
          # Secrets - S3 credentials for snapshots/backup (if using S3 for backups)
          [ -n "${{ secrets.S3_AWS_ACCESS_KEY_ID }}" ] && HELM_ARGS="$HELM_ARGS --set opensearch.snapshots.s3.keyId=${{ secrets.S3_AWS_ACCESS_KEY_ID }}"
          [ -n "${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}" ] && HELM_ARGS="$HELM_ARGS --set opensearch.snapshots.s3.keySecret=${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}"
          
          # Variables (only add if set, otherwise use values.yaml defaults)
          [ -n "${{ vars.ATP_STORAGE_PROVIDER }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.provider=${{ vars.ATP_STORAGE_PROVIDER }}"
          [ -n "${{ vars.ATP_STORAGE_SERVER_URL }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.serverUrl=${{ vars.ATP_STORAGE_SERVER_URL }}"
          [ -n "${{ vars.ATP_STORAGE_SERVER_UI_URL }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.serverUiUrl=${{ vars.ATP_STORAGE_SERVER_UI_URL }}"
          [ -n "${{ vars.ATP_STORAGE_BUCKET }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.bucket=${{ vars.ATP_STORAGE_BUCKET }}"
          [ -n "${{ vars.AWS_REGION }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpStorage.region=${{ vars.AWS_REGION }}"
          [ -n "${{ vars.ATP_REPORT_VIEW_UI_URL }}" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.atpReportViewUiUrl=${{ vars.ATP_REPORT_VIEW_UI_URL }}"
          
          # Environment name (use input or variable)
          ENV_NAME="${{ vars.ENVIRONMENT_NAME }}"
          [ -z "$ENV_NAME" ] && ENV_NAME="${{ github.event.inputs.environment }}"
          [ -n "$ENV_NAME" ] && HELM_ARGS="$HELM_ARGS --set integrationTests.environmentName=$ENV_NAME"
          
          # MONITORED_IMAGES for opensearch_images test
          # Format requires registry:port so split by ':' gives 3 parts (test uses parts[-1] for tag)
          # Using temp file to avoid shell escaping issues with spaces and special chars
          cat > /tmp/monitored-images-values.yaml << 'EOF'
          integrationTests:
            monitoredImages: "statefulset opensearch-master opensearch ghcr.io:443/netcracker/qubership-docker-opensearch-3:main,deployment opensearch-curator opensearch-curator ghcr.io:443/netcracker/qubership-opensearch-curator:main,deployment opensearch-dbaas-adapter opensearch-dbaas-adapter ghcr.io:443/netcracker/qubership-opensearch-dbaas-adapter:main,deployment opensearch-integration-tests opensearch-integration-tests ghcr.io:443/elbe0116/qubership-opensearch-integration-tests:PSUPATPOS-63"
          EOF
          HELM_ARGS="$HELM_ARGS -f /tmp/monitored-images-values.yaml"
          
          # AWS EKS uses gp2/gp3 storage class instead of "standard"
          HELM_ARGS="$HELM_ARGS --set opensearch.master.persistence.storageClass=gp2"
          
          # Reduce resource requirements for smaller clusters + increase liveness delay
          # Enable fixmount initContainer to fix permissions on EBS volumes
          # Disable integrationTests.affinity to avoid YAML parse error (template uses toJson)
          # Use busybox from AWS ECR Public to avoid Docker Hub rate limits
          cat > /tmp/resource-values.yaml << 'EOF'
          opensearch:
            initContainer:
              dockerImage: public.ecr.aws/docker/library/busybox:1.36
            fixmount:
              enabled: true
            master:
              resources:
                requests:
                  memory: 1Gi
                  cpu: 100m
                limits:
                  memory: 2Gi
                  cpu: 500m
              javaOpts: "-Xms512m -Xmx512m"
              livenessProbe:
                tcpSocket:
                  port: transport
                initialDelaySeconds: 300
                periodSeconds: 20
                failureThreshold: 10
              affinity: {}
          integrationTests:
            affinity: null
          EOF
          HELM_ARGS="$HELM_ARGS -f /tmp/resource-values.yaml"
          
          echo "Helm additional args: $HELM_ARGS"
          
          # Debug: show key values from values.yaml
          echo "=== Debug: Key values ==="
          grep -E "^\s*(enabled|prometheusUrl):" ./operator/charts/helm/opensearch-service/values.yaml | head -20
          echo "========================="
          
          helm install --namespace=${{ vars.OPENSEARCH_INSTALL_NAMESPACE }} \
            --create-namespace \
            -f ./operator/charts/helm/opensearch-service/values.yaml \
            opensearch-service ./operator/charts/helm/opensearch-service \
            $HELM_ARGS

